/* MooRainbow 1.3 by Djamil Legato (w00fz) and Christopher Beloch, MIT-style license */
var MooRainbow=new Class({options:{id:"mooRainbow",prefix:"moor-",imgPath:"images/",startColor:[255,0,0],wheel:!1,onComplete:Class.empty,onChange:Class.empty},initialize:function(a,b){this.element=document.id(a);if(!this.element)return;this.setOptions(b),this.sliderPos=0,this.pickerPos={x:0,y:0},this.backupColor=this.options.startColor,this.currentColor=this.options.startColor,this.sets={rgb:[],hsb:[],hex:[]},this.pickerClick=this.sliderClick=!1,this.layout||this.doLayout(),this.OverlayEvents(),this.sliderEvents(),this.backupEvent(),this.options.wheel&&this.wheelEvents(),this.element.addEvent("click",function(a){this.toggle(a)}.bind(this)),this.layout.overlay.setStyle("background-color",this.options.startColor.rgbToHex()),this.layout.backup.setStyle("background-color",this.backupColor.rgbToHex()),this.pickerPos.x=this.snippet("curPos").l+this.snippet("curSize","int").w,this.pickerPos.y=this.snippet("curPos").t+this.snippet("curSize","int").h,this.manualSet(this.options.startColor),this.pickerPos.x=this.snippet("curPos").l+this.snippet("curSize","int").w,this.pickerPos.y=this.snippet("curPos").t+this.snippet("curSize","int").h,this.sliderPos=this.snippet("arrPos")-this.snippet("arrSize","int"),window.khtml&&this.hide()},toggle:function(){this[this.visible?"hide":"show"]()},show:function(){this.rePosition(),this.layout.setStyle("display","block"),this.layout.set("aria-hidden","false"),this.visible=!0},hide:function(){this.layout.setStyles({display:"none"}),this.layout.set("aria-hidden","true"),this.visible=!1},manualSet:function(a,b){if(!b||b!="hsb"&&b!="hex")b="rgb";var c,d,e;b=="rgb"?(c=a,d=a.rgbToHsb(),e=a.rgbToHex()):b=="hsb"?(d=a,c=a.hsbToRgb(),e=c.rgbToHex()):(e=a,c=a.hexToRgb(!0),d=c.rgbToHsb()),this.setMooRainbow(c),this.autoSet(d)},autoSet:function(a){var b=this.snippet("curSize","int").h,c=this.snippet("curSize","int").w,d=this.layout.overlay.height,e=this.layout.overlay.width,f=this.layout.slider.height,g=this.snippet("arrSize","int"),h,i=Math.round(e*a[1]/100-c),j=Math.round(-(d*a[2]/100)+d-b),k=Math.round(f*a[0]/360);k=k==360?0:k;var l=f-k+this.snippet("slider")-g;h=[this.sets.hsb[0],100,100].hsbToRgb().rgbToHex(),this.layout.cursor.setStyles({top:j,left:i}),this.layout.arrows.setStyle("top",l),this.layout.overlay.setStyle("background-color",h),this.sliderPos=this.snippet("arrPos")-g,this.pickerPos.x=this.snippet("curPos").l+c,this.pickerPos.y=this.snippet("curPos").t+b},setMooRainbow:function(a,b){if(!b||b!="hsb"&&b!="hex")b="rgb";var c,d,e;b=="rgb"?(c=a,d=a.rgbToHsb(),e=a.rgbToHex()):b=="hsb"?(d=a,c=a.hsbToRgb(),e=c.rgbToHex()):(e=a,c=a.hexToRgb(),d=c.rgbToHsb()),this.sets={rgb:c,hsb:d,hex:e},this.pickerPos.x||this.autoSet(d),this.RedInput.value=c[0],this.GreenInput.value=c[1],this.BlueInput.value=c[2],this.HueInput.value=d[0],this.SatuInput.value=d[1],this.BrighInput.value=d[2],this.hexInput.value=e,this.currentColor=c,this.chooseColor.setStyle("background-color",c.rgbToHex()),this.fireEvent("onChange",[this.sets,this])},parseColors:function(a,b,c){var d=Math.round(a*100/this.layout.overlay.width),e=100-Math.round(b*100/this.layout.overlay.height),f=360-Math.round(c*360/this.layout.slider.height)+this.snippet("slider")-this.snippet("arrSize","int");return f-=this.snippet("arrSize","int"),f=f>=360?0:f<0?0:f,d=d>100?100:d<0?0:d,e=e>100?100:e<0?0:e,[f,d,e]},OverlayEvents:function(){var a,b,c,d;b=this.snippet("curSize","int").h,c=this.snippet("curSize","int").w,d=this.arrRGB.concat(this.arrHSB,this.hexInput),document.addEvent("click",function(){this.visible&&this.hide(this.layout)}.bind(this)),d.each(function(a){a.addEvent("keydown",this.eventKeydown.bind(this,a)),a.addEvent("keyup",this.eventKeyup.bind(this,a))},this),[this.element,this.layout].each(function(a){a.addEvents({click:function(a){a.stop()},keyup:function(a){a.key=="esc"&&this.visible&&this.hide(this.layout)}.bind(this)},this)},this),a={x:[0-c,this.layout.overlay.width-c],y:[0-b,this.layout.overlay.height-b]},this.layout.drag=new Drag(this.layout.cursor,{onStart:this.overlayDrag.bind(this),onDrag:this.overlayDrag.bind(this),snap:0}),this.layout.overlay2.addEvent("mousedown",function(a){this.layout.cursor.setStyles({top:a.page.y-this.layout.overlay.getTop()-b,left:a.page.x-this.layout.overlay.getLeft()-c}),this.overlayDrag.call(this),this.layout.drag.start(a)}.bind(this)),this.okButton.addEvent("click",function(){this.currentColor==this.options.startColor?(this.hide(),this.fireEvent("onComplete",[this.sets,this])):(this.backupColor=this.currentColor,this.layout.backup.setStyle("background-color",this.backupColor.rgbToHex()),this.hide(),this.fireEvent("onComplete",[this.sets,this]))}.bind(this))},overlayDrag:function(){var a=this.snippet("curSize","int").h,b=this.snippet("curSize","int").w;this.pickerPos.x=this.snippet("curPos").l+b,this.pickerPos.y=this.snippet("curPos").t+a,this.setMooRainbow(this.parseColors(this.pickerPos.x,this.pickerPos.y,this.sliderPos),"hsb"),this.fireEvent("onChange",[this.sets,this])},sliderEvents:function(){var a=this.snippet("arrSize","int"),b;b=[0+this.snippet("slider")-a,this.layout.slider.height-a+this.snippet("slider")],this.layout.sliderDrag=new Drag(this.layout.arrows,{limit:{y:b},modifiers:{x:!1},onStart:this.sliderDrag.bind(this),onDrag:this.sliderDrag.bind(this),snap:0}),this.layout.slider.addEvent("mousedown",function(b){this.layout.arrows.setStyle("top",b.page.y-this.layout.slider.getTop()+this.snippet("slider")-a),this.sliderDrag.call(this),this.layout.sliderDrag.start(b)}.bind(this))},sliderDrag:function(){var a=this.snippet("arrSize","int"),b;this.sliderPos=this.snippet("arrPos")-a,this.setMooRainbow(this.parseColors(this.pickerPos.x,this.pickerPos.y,this.sliderPos),"hsb"),b=[this.sets.hsb[0],100,100].hsbToRgb().rgbToHex(),this.layout.overlay.setStyle("background-color",b),this.fireEvent("onChange",[this.sets,this])},backupEvent:function(){this.layout.backup.addEvent("click",function(){this.manualSet(this.backupColor),this.fireEvent("onChange",[this.sets,this])}.bind(this))},wheelEvents:function(){var a=this.arrRGB.copy().extend(this.arrHSB);a.each(function(a){a.addEvents({mousewheel:function(b){this.eventKeys(b,a)}.bind(this),keydown:function(b){this.eventKeys(b,a)}.bind(this)})},this),[this.layout.arrows,this.layout.slider].each(function(a){a.addEvents({mousewheel:function(a){this.eventKeys(a,this.arrHSB[0],"slider")}.bind(this),keydown:function(a){this.eventKeys(a,this.arrHSB[0],"slider")}.bind(this)})},this)},eventKeys:function(a,b,c){var d,e;c=c?this.arrHSB[0]:b.id;if(a.type=="keydown")if(a.key=="up")d=1;else if(a.key=="down")d=-1;else return;else a.type==Element.Events.mousewheel.type&&(d=a.wheel>0?1:-1);this.arrRGB.test(b)?e="rgb":this.arrHSB.test(b)?e="hsb":e="hsb";if(e=="rgb"){var f=this.sets.rgb,g=this.sets.hsb,h=this.options.prefix,i,j=b.value.toInt()+d;j=j>255?255:j<0?0:j;switch(b.className){case h+"rInput":i=[j,f[1],f[2]];break;case h+"gInput":i=[f[0],j,f[2]];break;case h+"bInput":i=[f[0],f[1],j];break;default:i=f}this.manualSet(i),this.fireEvent("onChange",[this.sets,this])}else{var f=this.sets.rgb,g=this.sets.hsb,h=this.options.prefix,i,j=b.value.toInt()+d;b.className.test(/(HueInput)/)?j=j>359?0:j<0?0:j:j=j>100?100:j<0?0:j;switch(b.className){case h+"HueInput":i=[j,g[1],g[2]];break;case h+"SatuInput":i=[g[0],j,g[2]];break;case h+"BrighInput":i=[g[0],g[1],j];break;default:i=g}this.manualSet(i,"hsb"),this.fireEvent("onChange",[this.sets,this])}a.stop()},eventKeydown:function(a,b){var c=b.code,d=b.key;!a.className.test(/hexInput/)&&!(c>=48&&c<=57)&&d!="backspace"&&d!="tab"&&d!="delete"&&d!="left"&&d!="right"&&b.stop()},eventKeyup:function(a,b){var c=b.code,d=b.key,e,f,g=a.value.charAt(0);if(!a.value&&a.value!==0)return;if(a.className.test(/hexInput/)){if(g!="#"&&a.value.length!=6)return;if(g=="#"&&a.value.length!=7)return}else if(!(c>=48&&c<=57)&&!["backspace","tab","delete","left","right"].test(d)&&a.value.length>3)return;f=this.options.prefix;if(a.className.test(/(rInput|gInput|bInput)/)){if(a.value<0||a.value>255)return;switch(a.className){case f+"rInput":e=[a.value,this.sets.rgb[1],this.sets.rgb[2]];break;case f+"gInput":e=[this.sets.rgb[0],a.value,this.sets.rgb[2]];break;case f+"bInput":e=[this.sets.rgb[0],this.sets.rgb[1],a.value];break;default:e=this.sets.rgb}this.manualSet(e),this.fireEvent("onChange",[this.sets,this])}else if(!a.className.test(/hexInput/)){if(a.className.test(/HueInput/)&&a.value<0||a.value>360)return;if(a.className.test(/HueInput/)&&a.value==360)a.value=0;else if(a.className.test(/(SatuInput|BrighInput)/)&&a.value<0||a.value>100)return;switch(a.className){case f+"HueInput":e=[a.value,this.sets.hsb[1],this.sets.hsb[2]];break;case f+"SatuInput":e=[this.sets.hsb[0],a.value,this.sets.hsb[2]];break;case f+"BrighInput":e=[this.sets.hsb[0],this.sets.hsb[1],a.value];break;default:e=this.sets.hsb}this.manualSet(e,"hsb"),this.fireEvent("onChange",[this.sets,this])}else{e=a.value.hexToRgb(!0);if(isNaN(e[0])||isNaN(e[1])||isNaN(e[2]))return;if(e||e===0)this.manualSet(e),this.fireEvent("onChange",[this.sets,this])}},doLayout:function(){var a=this.options.id,b=this.options.prefix,c=a+" ."+b;this.layout=(new Element("div",{styles:{display:"block",position:"absolute"},id:a})).inject(document.body);var d=(new Element("div",{styles:{position:"relative"},"class":b+"box"})).inject(this.layout),e=(new Element("div",{styles:{position:"absolute",overflow:"hidden"},"class":b+"overlayBox"})).inject(d),f=(new Element("div",{styles:{position:"absolute",zIndex:1},"class":b+"arrows"})).inject(d);f.width=f.getStyle("width").toInt(),f.height=f.getStyle("height").toInt();var g=(new Element("img",{styles:{"background-color":"#fff",position:"relative",zIndex:2},src:this.options.imgPath+"moor_woverlay.png","class":b+"overlay"})).inject(e),h=(new Element("img",{styles:{position:"absolute",top:0,left:0,zIndex:2},src:this.options.imgPath+"moor_boverlay.png","class":b+"overlay"})).inject(e);if(window.ie6){e.setStyle("overflow","");var i=g.src;g.src=this.options.imgPath+"blank.gif",g.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+i+"', sizingMethod='scale')",i=h.src,h.src=this.options.imgPath+"blank.gif",h.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+i+"', sizingMethod='scale')"}g.width=h.width=e.getStyle("width").toInt(),g.height=h.height=e.getStyle("height").toInt();var j=(new Element("div",{styles:{overflow:"hidden",position:"absolute",zIndex:2},"class":b+"cursor"})).inject(e);j.width=j.getStyle("width").toInt(),j.height=j.getStyle("height").toInt();var k=(new Element("img",{styles:{position:"absolute","z-index":2},src:this.options.imgPath+"moor_slider.png","class":b+"slider"})).inject(d);this.layout.slider=Slick.find(document,"#"+c+"slider"),k.width=k.getStyle("width").toInt(),k.height=k.getStyle("height").toInt(),(new Element("div",{styles:{position:"absolute"},"class":b+"colorBox"})).inject(d),(new Element("div",{styles:{zIndex:2,position:"absolute"},"class":b+"chooseColor"})).inject(d),this.layout.backup=(new Element("div",{styles:{zIndex:2,position:"absolute",cursor:"pointer"},"class":b+"currentColor"})).inject(d);var l=(new Element("label")).inject(d).setStyle("position","absolute"),m=l.clone().inject(d).addClass(b+"gLabel").appendText("G: "),n=l.clone().inject(d).addClass(b+"bLabel").appendText("B: ");l.appendText("R: ").addClass(b+"rLabel");var o=(new Element("input")).set("disabled",!0),p=o.clone().inject(m).addClass(b+"gInput"),q=o.clone().inject(n).addClass(b+"bInput");o.inject(l).addClass(b+"rInput");var r=(new Element("label")).inject(d).setStyle("position","absolute"),s=r.clone().inject(d).addClass(b+"SatuLabel").appendText("S: "),t=r.clone().inject(d).addClass(b+"BrighLabel").appendText("B: ");r.appendText("H: ").addClass(b+"HueLabel");var u=(new Element("input")).set("disabled",!0),v=u.clone().inject(s).addClass(b+"SatuInput"),w=u.clone().inject(t).addClass(b+"BrighInput");u.inject(r).addClass(b+"HueInput"),s.appendText(" %"),t.appendText(" %"),(new Element("span",{styles:{position:"absolute"},"class":b+"ballino"})).set("html"," &deg;").inject(r,"after");var x=(new Element("label")).inject(d).setStyle("position","absolute").addClass(b+"hexLabel").appendText("#hex: ").adopt((new Element("input")).addClass(b+"hexInput")),y=(new Element("input",{styles:{position:"absolute"},type:"button",value:"Select","class":b+"okButton"})).inject(d);this.rePosition();var z=$$("#"+c+"overlay");this.layout.overlay=z[0],this.layout.overlay2=z[1],this.layout.cursor=Slick.find(document,"#"+c+"cursor"),this.layout.arrows=Slick.find(document,"#"+c+"arrows"),this.chooseColor=Slick.find(document,"#"+c+"chooseColor"),this.layout.backup=Slick.find(document,"#"+c+"currentColor"),this.RedInput=Slick.find(document,"#"+c+"rInput"),this.GreenInput=Slick.find(document,"#"+c+"gInput"),this.BlueInput=Slick.find(document,"#"+c+"bInput"),this.HueInput=Slick.find(document,"#"+c+"HueInput"),this.SatuInput=Slick.find(document,"#"+c+"SatuInput"),this.BrighInput=Slick.find(document,"#"+c+"BrighInput"),this.hexInput=Slick.find(document,"#"+c+"hexInput"),this.arrRGB=[this.RedInput,this.GreenInput,this.BlueInput],this.arrHSB=[this.HueInput,this.SatuInput,this.BrighInput],this.okButton=Slick.find(document,"#"+c+"okButton"),this.layout.cursor.setStyle("background-image","url("+this.options.imgPath+"moor_cursor.gif)"),window.khtml||this.hide()},rePosition:function(){var a=this.element.getCoordinates();this.layout.setStyles({left:a.left-325,top:a.top+a.height+8})},snippet:function(a,b){var c;b=b?b:"none";switch(a){case"arrPos":var d=this.layout.arrows.getStyle("top").toInt();c=d;break;case"arrSize":var e=this.layout.arrows.height;e=b=="int"?(e/2).toInt():e,c=e;break;case"curPos":var f=this.layout.cursor.getStyle("left").toInt(),d=this.layout.cursor.getStyle("top").toInt();c={l:f,t:d};break;case"slider":var d=this.layout.slider.getStyle("marginTop").toInt();c=d;break;default:var e=this.layout.cursor.height,g=this.layout.cursor.width;e=b=="int"?(e/2).toInt():e,g=b=="int"?(g/2).toInt():g,c={w:g,h:e}}return c}});MooRainbow.implement(new Options),MooRainbow.implement(new Events);